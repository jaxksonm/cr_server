{% extends "base.html" %}
{% block content %}
<div class = "bubble">
  <h1>{{ tournament['name'] }}</h1>
  <p> {{ tournament['date'] }} in {{ tournament['location'] }}</p>
  <p class = "muted"> {{ tournament['description'] }}</p>
  
<div class="lr">
{% if session.get('user_id') %}
  {% if not joined %}
    <form method="post"
      action="{{ url_for('tournament_join', tid=tournament['id']) }}">
      <button type="submit">Join Tournament</button>
    </form>
  {% else %}
    <form method="post"
      action="{{ url_for('tournament_leave', tid=tournament['id']) }}"
      onsubmit="return confirm('Are you sure you want to leave this tournament?');">
    <button type="submit">Leave Tournament</button>
    </form>
  {% endif %}
{% else %}
<form method="get"
      action="{{ url_for('login')}}">
    <button type="submit">Log In</button> to join the tournament.
</form>
{% endif %}
<form method="get"
      action="{{ url_for('tournaments_list')}}">
    <button class="red" type="submit">Back</button>
</form></div>
</div>

<div class="bubble">
  <h2>Participants</h2>
  {% if session.get("is_admin") %}
  <form method="post" action="{{ url_for('tournament_view', tid=tournament['id']) }}?generate=1">
    <button type="submit">Start</button>
  </form>
  {% endif %}
  {% if participants %}
  <ul>
  {% for p in participants %}
    <li>{{ p[1] }} {% if p[2] %}(seed {{ p[2] }}){% endif %}</li>
  {% endfor %}
  </ul>
  {% else %}
    <p>No participants yet.</p>
  {% endif %}
</div>


<div class = "bubble">
  <h2>Matches</h2>
  {% if rounds %}
    {% for rnum, matches in rounds.items() %}
      <h3>Round {{ rnum }}</h3>
      <ul>
      {% for m in matches %}
        <li>
          {% set p1 = (m['player1_id'] and (participants | selectattr('0','equalto', m['player1_id']) | list | first)) %}
          {% set p2 = (m['player2_id'] and (participants | selectattr('0','equalto', m['player2_id']) | list | first)) %}
          {{ p1[1] if p1 else 'TBD' }} vs {{ p2[1] if p2 else 'BYE' }} â€” score: {{ m['score1'] }}-{{ m['score2'] }}
        </li>
      {% endfor %}
      </ul>
    {% endfor %}
  {% else %}
    <p>Tournament hasn't started yet.</p>
  {% endif %}
  {% if session.get('is_admin') %}
  <div class="lr">
<form method="post" action="{{ url_for('tournament_end', tid=tournament['id']) }}"
        onsubmit="return confirm('Are you sure you want to end this tournament?');">
    <button type="submit">End Tournament</button>
  </form>
  <form method="post" action="{{ url_for('tournament_delete', tid=tournament['id']) }}"
        onsubmit="return confirm('Are you sure you want to delete this tournament?');">
    <button class="red" type="submit">Delete Tournament</button>
  </form>
  </div>
  
{% endif %}
  </div>

  {% endblock %}
